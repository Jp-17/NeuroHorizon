# Phase 1.3 预测窗口梯度测试

- **日期**：2026-03-02
- **对应 plan.md 任务**：1.3.1 ~ 1.3.4（预测窗口梯度测试）
- **任务目标**：在不同预测窗口（250ms / 500ms / 1000ms）下评估模型性能，确定 Phase 2/3 的主窗口

---

## 实验总览

| 实验 | 预测窗口 | Bins | 模式 | Best R² | Best Epoch | Final R² | Final Val Loss |
|------|---------|------|------|---------|-----------|---------|---------------|
| 1.3.1 | 250ms | 12 | AR | **0.2658** | 229 | 0.2606 | 0.3142 |
| 1.3.2 | 500ms | 25 | AR | 0.2417 | 229 | 0.2346 | 0.3124 |
| 1.3.3 | 1000ms | 50 | AR | 0.2343 | 299 | 0.2343 | 0.3159 |
| 1.3.3 对照 | 1000ms | 50 | non-AR | 0.2354 | 259 | 0.2335 | 0.3159 |

---

## 1.3.1 250ms 预测窗口实验

- **配置**：`train_small_250ms.yaml`
- **数据**：Perich-Miller 10 sessions
- **方案**：Trial 对齐方案 A（输入 = hold period，预测 = reach period 前 250ms）
- **结果**：Best R² = 0.2658（epoch 229）
- **结果目录**：`results/logs/phase1_small_250ms/`

## 1.3.2 500ms 预测窗口实验

- **配置**：`train_small_500ms.yaml`
- **结果**：Best R² = 0.2417（epoch 229）
- **分析**：相比 250ms 下降约 9%，性能衰减合理
- **结果目录**：`results/logs/phase1_small_500ms/`

## 1.3.3 1000ms 预测窗口实验

- **配置**：`train_small_1000ms.yaml`（AR）/ `train_small_1000ms_noar.yaml`（non-AR）
- **AR 结果**：Best R² = 0.2343（epoch 299），仍在缓慢提升
- **non-AR 结果**：Best R² = 0.2354（epoch 259）
- **AR vs non-AR 差异**：< 0.002（几乎无差异）
- **分析**：
  - 1000ms 下 AR 和 non-AR 性能几乎相同，进一步验证了 1.2.2 的发现：固定 position embedding 使两者数学等价
  - Scheduled sampling 对当前架构无意义
- **结果目录**：`results/logs/phase1_small_1000ms/`、`results/logs/phase1_small_1000ms_noar/`

## 1.3.4 预测窗口汇总报告

### 性能随窗口长度的衰减

```
窗口长度    Bins    Best R²    相对 250ms 衰减
250ms       12      0.2658     baseline
500ms       25      0.2417     -9.1%
1000ms      50      0.2343     -11.9%
```

- 从 250ms 到 500ms 衰减 9.1%，从 500ms 到 1000ms 仅衰减 3.1%
- 衰减曲线呈**亚线性**：窗口翻倍并不导致性能翻倍下降

### AR vs non-AR 对比

- 1000ms 窗口下 AR (0.2343) vs non-AR (0.2354) 差异仅 0.001
- 原因：固定 position embedding → 无暴露偏差 → AR/non-AR 等价

### 关键决策

- **推荐 500ms 作为 Phase 2/3 主窗口**
  - 理由：相比 250ms 预测范围翻倍，性能仅下降 9%
  - 1000ms 的额外收益有限（仅多 3% 性能下降），但计算量显著增加
- 后续若需更长窗口预测，可作为消融实验补充

### 结果文件

- 完整报告：`results/logs/phase1_full_report.json`
- 汇总数据：`results/logs/phase1_summary.json`
- 分析脚本：
  - `scripts/analysis/neurohorizon/full_report.py`（完整报告生成）
  - `scripts/analysis/neurohorizon/summary.py`（快速汇总）
  - `scripts/analysis/neurohorizon/noise_floor.py`（Poisson noise floor 分析）
