# Phase 1.1 核心模块实现

- **日期**：2026-03-02
- **对应 plan.md 任务**：1.1.1 ~ 1.1.6（核心模块实现）
- **任务目标**：在 POYO+ 基础上实现 NeuroHorizon 自回归解码器的全部核心模块

---

## 1.1.1 Poisson NLL Loss

- **文件**：`torch_brain/nn/loss.py`
- **实现**：新增 `PoissonNLLLoss` 类
  - `forward(log_rate, spike_count, weights)` 接口
  - 数值稳定性：clamp log_rate 避免 exp 溢出
  - 支持 per-bin 加权（用于 loss mask）
- **注册**：在 `torch_brain/nn/__init__.py` 中导出

## 1.1.2 注册 spike_counts 输出模态

- **文件**：`torch_brain/registry.py`
- **实现**：在 `OutputType` 中添加 `SPIKE_COUNTS` 模态
  - `timestamp_key = "spike_timestamps"`
  - `value_key = "spike_counts"`
  - `loss_fn = PoissonNLLLoss`

## 1.1.3 RotarySelfAttention 支持 causal mask

- **文件**：`torch_brain/nn/rotary_attention.py`
- **修改**：
  - `rotary_attn_pytorch_func` 的 mask reshape 逻辑支持 2D/3D/4D mask
  - 新增 `create_causal_mask(seq_len)` 工具函数
  - xformers 后端同步支持
- **测试**：`scripts/tests/test_causal_mask.py`（从 `/tmp/neurohorizon_test_causal.py` 迁移）
- **执行命令**：
  ```bash
  conda activate poyo
  cd /root/autodl-tmp/NeuroHorizon
  python scripts/tests/test_causal_mask.py
  ```

## 1.1.4 自回归 Cross-Attention Decoder

- **文件**：`torch_brain/nn/autoregressive_decoder.py`（新建）
- **实现**：
  - `AutoregressiveDecoder` 类：cross-attn(bin_query → encoder_latents) + causal self-attn(bins) + FFN
  - Per-Neuron MLP Head：`concat(bin_repr, unit_emb) → log-rate`
  - 支持 teacher forcing 和自回归推理两种模式
  - 使用固定 position embedding（非学习型），这使得 TF 和 AR 模式数学等价
- **测试**：`scripts/tests/test_decoder.py`（从 `/tmp/neurohorizon_test_decoder.py` 迁移）
- **执行命令**：
  ```bash
  conda activate poyo
  cd /root/autodl-tmp/NeuroHorizon
  python scripts/tests/test_decoder.py
  ```

## 1.1.5 组装 NeuroHorizon 模型

- **文件**：`torch_brain/models/neurohorizon.py`（新建）
- **1.1.5a 模型骨架**：复用 POYO encoder + processing layers，集成 IDEncoder 预留接口
- **1.1.5b Decoder 集成**：接入 AutoregressiveDecoder，实现完整 forward()
- **1.1.5c tokenize() 实现**：构建 spike count targets（binning spike events），处理参考窗口
- **注册**：更新 `torch_brain/models/__init__.py` 导出
- **测试**：`scripts/tests/test_model.py`（从 `/tmp/neurohorizon_test_model.py` 迁移）
- **执行命令**：
  ```bash
  conda activate poyo
  cd /root/autodl-tmp/NeuroHorizon
  python scripts/tests/test_model.py
  ```

## 1.1.6 训练脚本与评估指标

- **训练脚本**：`examples/neurohorizon/train.py`（新建）
  - 基于 PyTorch Lightning + Hydra 配置
  - 支持 WandB 日志记录
  - 内联 R² 计算（未创建独立的 neurohorizon_metrics.py）
- **配置文件**：`examples/neurohorizon/configs/`
  - `train_small.yaml` — Small 配置基础版（250ms 预测窗口，12 bins）
  - `train_small_500ms.yaml` — 500ms 预测窗口（25 bins）
  - `train_small_1000ms.yaml` — 1000ms 预测窗口（50 bins）
  - `train_small_1000ms_noar.yaml` — 1000ms 非自回归对照
- **执行命令**（以 250ms 为例）：
  ```bash
  conda activate poyo
  cd /root/autodl-tmp/NeuroHorizon
  python examples/neurohorizon/train.py --config-name=train_small
  ```

---

## 修改/新建文件清单

| 文件 | 操作 |
|------|------|
| `torch_brain/nn/loss.py` | 修改（新增 PoissonNLLLoss） |
| `torch_brain/nn/autoregressive_decoder.py` | 新建 |
| `torch_brain/nn/rotary_attention.py` | 修改（causal mask 支持） |
| `torch_brain/nn/__init__.py` | 修改（导出新模块） |
| `torch_brain/registry.py` | 修改（spike_counts 模态） |
| `torch_brain/models/neurohorizon.py` | 新建 |
| `torch_brain/models/__init__.py` | 修改（导出 NeuroHorizon） |
| `examples/neurohorizon/train.py` | 新建 |
| `examples/neurohorizon/configs/*.yaml` | 新建（4 个配置文件） |

## 备注

- `torch_brain/utils/neurohorizon_metrics.py` **未独立创建**，R² 评估指标直接内联在 `train.py` 的 validation_step 中
- 一次性 patch 脚本（已应用，代码已在 git 中，无需迁移）：
  - `/tmp/neurohorizon_fix_pad.py` — 修复 padding 问题
  - `/tmp/neurohorizon_patch_attention.py` — 修补 attention 模块
  - `/tmp/neurohorizon_patch_loss.py` — 修补 loss 模块
  - `/tmp/neurohorizon_patch_models_init.py` — 修补 models __init__
  - `/tmp/neurohorizon_patch_nn_init.py` — 修补 nn __init__
  - `/tmp/neurohorizon_patch_registry.py` — 修补 registry
