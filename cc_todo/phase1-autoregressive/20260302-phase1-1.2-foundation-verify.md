# Phase 1.2 基础功能验证

- **日期**：2026-03-02
- **对应 plan.md 任务**：1.2.1 ~ 1.2.2（基础功能验证）
- **任务目标**：验证 NeuroHorizon 模型的 teacher forcing 训练收敛性和自回归推理正确性

---

## 1.2.1 Teacher Forcing 模式训练

- **配置**：`examples/neurohorizon/configs/train_small.yaml`（Small 配置，250ms 预测窗口，12 bins）
- **数据**：Perich-Miller 2018，10 sessions
- **训练轮数**：300 epochs
- **执行命令**：
  ```bash
  conda activate poyo
  cd /root/autodl-tmp/NeuroHorizon
  python examples/neurohorizon/train.py --config-name=train_small
  ```

### 训练结果

| 指标 | 数值 |
|------|------|
| Best R² | 0.2658 |
| Best Epoch | 229 |
| Final R² | 0.2606 |
| Final Val Loss | 0.3142 |

- Loss 收敛正常，R² 在 epoch ~100 后趋于稳定（0.25~0.27 区间波动）
- Poisson NLL Loss 适配 spike count 数据，未出现 NaN 或数值不稳定
- 预测 spike count 分布合理（符合 Poisson 分布特性）

### 结果文件

- 训练日志：`results/logs/phase1_small_250ms/lightning_logs/`
- 模型检查点：`results/logs/phase1_small_250ms/lightning_logs/version_0/checkpoints/`

---

## 1.2.2 自回归推理验证

- **脚本**：`scripts/analysis/neurohorizon/ar_verify.py`（从 `/tmp/nh_ar_verify.py` 迁移）
- **验证方法**：
  1. 加载训练好的 250ms 模型
  2. 同一批 validation 数据分别用 Teacher Forcing 和 Autoregressive 模式推理
  3. 逐 bin 对比 R² 和 NLL
- **执行命令**：
  ```bash
  conda activate poyo
  cd /root/autodl-tmp/NeuroHorizon
  python scripts/analysis/neurohorizon/ar_verify.py
  ```
  > 注：脚本内硬编码了 checkpoint 路径 `results/logs/phase1_small_250ms/lightning_logs/version_0/checkpoints/last.ckpt`

### 验证结果

| 指标 | Teacher Forcing | Autoregressive | 差异 |
|------|----------------|----------------|------|
| Overall R² | 0.2633 | 0.2633 | < 1e-6 |
| Max per-bin R² diff | — | — | 3e-6 |
| Causal mask | — | PASSED | — |

### 关键发现

- **TF 和 AR 推理结果数学等价**（max diff ≈ 3e-6，浮点精度级别）
- **原因**：decoder 使用**固定 position embedding**（非学习型、非依赖前步输出），因此 TF 模式下每个 bin query 的输入与 AR 模式完全相同
- **结论**：Scheduled sampling 不适用于当前架构（因为没有"暴露偏差"问题）
- Causal mask 验证通过：未来 token 的信息被正确阻止

### 结果文件

- AR 验证结果：`results/logs/phase1_small_250ms/ar_verify_results.json`
