# NeuroHorizon 仓库操作与进展整理

> 整理日期：2026-02-23
> 基准 commit：`1ceb841eb6cf0f42004a6b3cf019e3ef4e4d55cf`（"添加数据集下载说明"）
> 整理范围：自上述 commit 之后的所有 git 提交记录，以及 cc_todo 文档记录

---

## 一、概述

本文档汇总了从 commit `1ceb841`（"添加数据集下载说明"）之后，NeuroHorizon 仓库所经历的全部代码变更、安装配置、数据下载处理、训练运行及评估等操作，共涉及 **40 个新增 commit**（截至 2026-02-22），横跨 Phase 0 到 Phase 4。

---

## 二、Git 提交列表（从旧到新）

| Commit | 提交信息 | 日期 |
|--------|----------|------|
| `01787f9` | Phase 0: 添加数据管线脚本和项目分析文档 | 2026-02-21 |
| `f527040` | Phase 0 + Phase 2 core: data pipeline, IDEncoder, NeuroHorizon model | 2026-02-21 |
| `081d393` | Phase 2.5-2.6: training pipeline, metrics, and data fixes | 2026-02-21 |
| `c05c786` | Update work log with training results + add POYO baseline scaffold | 2026-02-21 |
| `9ee99ba` | Update work log + fix POYO baseline config | 2026-02-21 |
| `81ed536` | Fix POYO baseline training bugs + launch parallel training | 2026-02-21 |
| `ab45b5b` | Add training monitor script + gradient clipping for POYO baseline | 2026-02-21 |
| `051cded` | Update work log v0.6: POYO baseline bugs fixed, both trainings running | 2026-02-21 |
| `7e8c671` | Fix POYO baseline deepcopy bottleneck in IBLEagerDataset | 2026-02-21 |
| `53e6bec` | Update work log with first validation results | 2026-02-21 |
| `0e8ba7a` | Update work log with POYO baseline validation results | 2026-02-21 |
| `be12999` | Add evaluation scripts, feature normalization, and training improvements | 2026-02-21 |
| `df50bfa` | Fix deepcopy bottleneck in NeuroHorizon EagerDataset | 2026-02-21 |
| `72d6690` | Add DINOv2 embedding extraction script for Allen stimuli | 2026-02-21 |
| `89d31e7` | Add multimodal cross-attention module for image and behavior injection | 2026-02-21 |
| `e33abd2` | Update work log: NH epoch 9 validation (bits/spike -1.008 -> -0.724) | 2026-02-21 |
| `f190f04` | Update work log v0.7: deepcopy fix, training progress, phase summary | 2026-02-21 |
| `d5f6131` | Integrate multimodal cross-attention into NeuroHorizon model | 2026-02-21 |
| `4c42f18` | Add cross-session evaluation and ablation experiment scripts | 2026-02-21 |
| `e5283e0` | Add embedding_mode ablation flag to NeuroHorizon model | 2026-02-21 |
| `04d3d2e` | Update work log: Phase 3 complete, experiment infrastructure ready | 2026-02-21 |
| `b758073` | Add training curve visualization script and fix Allen session domain | 2026-02-21 |
| `082b9e8` | Fix multimodal collate: use Padded8Object type check instead of hasattr | 2026-02-21 |
| `d9e977e` | Add multimodal training preparation: union collate, multi-dir dataset, v2 configs | 2026-02-21 |
| `b5e0262` | Add CLIP image embeddings and v2 training configs | 2026-02-21 |
| `50cedf5` | Add training metrics and visualization figures | 2026-02-21 |
| `c03a283` | Update training progress: NH v1 epoch 14 bps=-0.573, POYO epoch 84 | 2026-02-21 |
| `762ff2d` | Add Phase 4 experiment scripts: horizon eval, multimodal ablation, results collector | 2026-02-21 |
| `65706be` | POYO epoch 89: catastrophic val_r2=-0.52, add training queue script | 2026-02-21 |
| `60a8239` | Update work log: POYO terminated (R²<0 after 106 epochs), NH epoch 14 results | 2026-02-21 |
| `2dcc2df` | NH v1 epoch 19: val_bps=-0.523, POYO epoch 99: partial recovery | 2026-02-21 |
| `7dae739` | Add comprehensive progress report and update training results | 2026-02-21 |
| `afc1eaf` | NH v2 epoch 19: val_bps=-0.456, fr_corr=0.814, R²=0.397 | 2026-02-21 |
| `f0f7b1f` | NH v2 best bps=-0.407 (epoch 54), v1 epoch 24 bps=-0.494 | 2026-02-22 |
| `25a93d4` | Training progress: v1 epoch 26 (bps=-0.494), v2 epoch 69 (bps converged -0.407) | 2026-02-22 |
| `975cfe0` | Fix eval scripts (Padded8Object bug) + v2 IBL final results | 2026-02-22 |
| `48cabee` | POYO baseline bugfix: 3 critical bugs fixed, 200-epoch training relaunched | 2026-02-22 |
| `9baa32b` | Add auto_launch_after_v1.sh, fix v2_beh/v2_mm GPU OOM | 2026-02-22 |
| `5c3f5a1` | NH v1 epoch 34: val_bps=-0.462, improvement rate slowing | 2026-02-22 |

---

## 三、环境安装与配置

### 3.1 POYO 基础环境（2026-02-19，见 poyo_setup_log.md）

在正式开始 NeuroHorizon 开发前，先建立了 POYO 运行环境并验证通过：

| 项目 | 内容 |
|------|------|
| Conda 环境名 | `poyo` |
| Python 版本 | 3.10 |
| 安装路径 | `miniconda3/envs/poyo/` |
| 安装方式 | `pip install -e "autodl-tmp/torch_brain[dev]"` |
| torch 版本 | 2.10.0+cu128（CUDA 12.8） |
| lightning 版本 | 2.6.1 |
| torch-optimizer 版本 | 0.3.0（包含 SparseLamb 优化器） |
| wandb 版本 | 0.25.0 |
| temporaldata 版本 | 0.1.3 |
| brainsets 版本 | 0.2.1.dev4（从 GitHub 源安装，替代 PyPI 的 0.2.0） |

brainsets 配置文件生成路径：`/root/.brainsets.yaml`

### 3.2 IBL 数据依赖扩展（2026-02-21）

在 `poyo` 环境中追加安装了：
- `ONE-api`：International Brain Laboratory 数据访问接口
- `ibllib`：IBL 数据处理库

### 3.3 Allen 独立环境（2026-02-21）

由于 `allensdk` 要求 `numpy==1.23.5`，与 IBL 的 numpy 版本不兼容，**单独创建了 `allen` conda 环境**，安装 `allensdk`。用于 Allen Brain Observatory 数据下载。

---

## 四、数据下载与存放位置

### 4.1 POYO 测试数据集（2026-02-19）

| 数据集 | 来源 | 存放路径 |
|--------|------|----------|
| pei_pandarinath_nlb_2021（MC Maze Small） | DANDI Archive（通过 brainsets prepare 下载） | `autodl-tmp/datasets/processed/pei_pandarinath_nlb_2021/` |
| 原始文件 | NWB 格式 | `autodl-tmp/datasets/raw/` |
| 处理后文件 | `jenkins_maze_train.h5`、`jenkins_maze_test.h5` | `autodl-tmp/datasets/processed/pei_pandarinath_nlb_2021/` |
| 大小 | ~51 MB | — |

### 4.2 IBL（International Brain Laboratory）数据（2026-02-21）

通过 `scripts/download_ibl.py` + `scripts/preprocess_ibl.py` 下载并处理，成功处理 10 个 session（12 个候选中 2 个失败）。

**存放路径**：`autodl-tmp/datasets/ibl_processed/`

| Session ID | Spikes | Units | Duration |
|------------|--------|-------|----------|
| a7eba2cf | 31.2M | 302 | 5382s |
| c46b8def | 27.9M | 294 | 5015s |
| ebce500b | 13.1M | 291 | 7200s |
| 5ae68c54 | 12.4M | 134 | 5853s |
| 11163613 | 7.6M | 138 | 5031s |
| 15b69921 | 7.0M | 128 | 5014s |
| 6899a67d | 3.0M | 80 | 6499s |
| de905562 | 2.2M | 19 | 4019s |
| e6594a5b | 1.6M | 70 | 4699s |
| d85c454e | 0.5M | 17 | 3691s |
| **总计** | **~107M** | **~1473** | **~52,403s** |

文件格式：HDF5，兼容 temporaldata 格式（包含 object、timekeys、absolute_start 等元数据属性）。

### 4.3 Allen Brain Observatory 数据（2026-02-21）

通过 `scripts/download_allen.py` 下载并处理 5 个 Neuropixels session。

**存放路径**：`autodl-tmp/datasets/allen_processed/`

| Session ID | Spikes | Units | Duration |
|------------|--------|-------|----------|
| allen_715093703 | 67.9M | 875 | 9629s |
| allen_719161530 | 64.6M | 751 | 9665s |
| allen_721123822 | 35.1M | 439 | 9811s |
| allen_732592105 | 60.4M | 818 | 9415s |
| allen_737581020 | 44.9M | 566 | 9277s |
| **总计** | **~273M** | **~3449** | **~47,797s** |

文件格式：HDF5，兼容 temporaldata 格式。

### 4.4 Allen 刺激帧与 CLIP Embedding（2026-02-21）

由于网络访问受限无法下载 DINOv2，使用本机缓存的 CLIP ViT-L/14（1.71 GiB）替代。

| 内容 | 存放路径 |
|------|----------|
| Allen 刺激帧（numpy 格式） | `autodl-tmp/datasets/allen_stimuli/` |
| CLIP embedding 文件 | `autodl-tmp/datasets/allen_embeddings/` |
| CLIP ViT-L/14 权重缓存 | HuggingFace 本地缓存（safetensors 格式，1.71 GiB） |

提取的 embedding 规格：
- Natural Movie 1: 900 frames → (900, 1024) embeddings
- Natural Movie 3: 3600 frames → (3600, 1024) embeddings
- Natural Scenes: 118 images → (118, 1024) embeddings

注入后 5 个 Allen session 的 HDF5 文件中增加了 `image_embeddings` group（~245 MB/session）。

---

## 五、仓库代码变更详情

### 5.1 新增核心模块（torch_brain 库）

| 文件 | 内容 |
|------|------|
| `torch_brain/nn/id_encoder.py` | IDEncoder 模块：3 层 MLP（33维特征 → model_dim），支持 compute_embeddings() 预计算 + forward() 索引查找；支持 `idencoder`/`random`/`mean` 三种消融模式 |
| `torch_brain/nn/multimodal.py` | 多模态交叉注意力模块：`MultimodalCrossAttention`（RoPE 时间对齐）+ `MultimodalEncoder`（封装图像和行为两路，~2.3M 参数） |
| `torch_brain/models/neurohorizon.py` | NeuroHorizon 完整模型：CausalRotarySelfAttention、PerNeuronHead、NeuroHorizon 主类，包含 tokenize() 和 compute_loss() |
| `torch_brain/utils/neurohorizon_metrics.py` | 评估指标：Poisson log-likelihood、bits/spike、firing rate correlation、R² |

**修改的已有文件**：

| 文件 | 修改内容 |
|------|----------|
| `torch_brain/nn/loss.py` | 添加 PoissonNLLLoss（支持 log-rate 输入 + spike count 目标） |
| `torch_brain/nn/__init__.py` | 导出 IDEncoder、MultimodalEncoder 等新模块 |
| `torch_brain/registry.py` | 注册 `wheel_velocity` 模态（IBL wheel velocity 解码） |
| `torch_brain/models/__init__.py` | 导出 NeuroHorizon 模型 |
| `torch_brain/models/poyo_plus.py` | 修复 task_emb Embedding 索引越界（`max(spec.id)+1` 替代 `len(specs)`） |
| `.gitignore` | 更新忽略规则 |

### 5.2 新增训练脚本与配置

**NeuroHorizon 训练**（`examples/neurohorizon/`）：

| 文件 | 内容 |
|------|------|
| `train.py` | 训练脚本（PyTorch Lightning + Hydra）：EagerDataset、neurohorizon_collate、NHTrainWrapper、NHDataModule |
| `configs/defaults.yaml` | 基础训练配置（batch_size=16, 100 epochs, bf16-mixed, AdamW + OneCycleLR） |
| `configs/train.yaml` | Hydra defaults 链 |
| `configs/model/neurohorizon_small.yaml` | Small 模型（~8.1M params, dim=256, depth=4） |
| `configs/model/neurohorizon_base.yaml` | Base 模型（~33M params, dim=512, depth=8） |
| `configs/model/neurohorizon_small_beh.yaml` | 行为条件模型（~10.2M params） |
| `configs/model/neurohorizon_small_mm.yaml` | 全模态模型（~12.8M params, image_dim=1024） |
| `configs/defaults_allen.yaml` | Allen 数据训练配置 |

**POYO 基线训练**（`examples/poyo_baseline/`）：

| 文件 | 内容 |
|------|------|
| `train.py` | POYO baseline 训练脚本（wheel velocity 解码，IBL 数据） |
| `configs/defaults.yaml` | 基线配置（batch_size=64, 200 epochs, SparseLamb 优化器） |
| `configs/model/poyo_small.yaml` | POYO Small（~3.5M params, dim=128, depth=8） |
| `configs/train.yaml` | Hydra defaults 链 |

### 5.3 新增数据处理脚本（scripts/）

| 脚本 | 功能 |
|------|------|
| `download_ibl.py` | IBL 数据下载（通过 ONE API） |
| `preprocess_ibl.py` | IBL 数据转 HDF5（temporaldata 格式） |
| `download_allen.py` | Allen Neuropixels 数据下载+预处理 |
| `extract_reference_features.py` | 每个 unit 提取 33 维参考特征（firing rate + ISI CV + ISI log-histogram + autocorrelation + Fano factor） |
| `normalize_reference_features.py` | 参考特征 z-score 归一化（原始备份至 `reference_features_raw`） |
| `validate_data.py` | HDF5 完整性验证（时间戳、unit index、NaN 检查） |
| `extract_dino_embeddings.py` | DINOv2 embedding 提取脚本（实际因网络受限未使用） |
| `extract_image_embeddings.py` | CLIP ViT-L/14 embedding 提取（离线模式，from safetensors） |
| `inject_dino_embeddings.py` | DINOv2 embedding 注入 Allen HDF5（保留供后续使用） |
| `inject_image_embeddings.py` | CLIP embedding 注入 Allen HDF5（已完成） |
| `debug_tokenizer.py` | tokenizer 调试工具 |

### 5.4 新增评估脚本（scripts/）

| 脚本 | 功能 |
|------|------|
| `evaluate_neurohorizon.py` | NeuroHorizon 后训练评估（per-session、per-unit 指标 + 可视化） |
| `evaluate_poyo_baseline.py` | POYO 基线后训练评估 |
| `evaluate_cross_session.py` | 跨 session 泛化评估（in-distribution vs cross-session BPS gap） |
| `evaluate_horizons.py` | 不同预测时间跨度评估（100ms/200ms/500ms/1s） |
| `run_ablations.py` | 消融实验运行器（IDEncoder 模式、prediction horizon、bin_size、多模态配置） |
| `collect_results.py` | 综合结果收集器（扫描所有训练日志 + 评估结果） |
| `compare_models.py` | 模型对比脚本 |
| `plot_results.py` | 结果可视化脚本 |
| `check_training.py` | 训练状态检查脚本 |

### 5.5 新增自动化脚本（scripts/）

| 脚本 | 功能 |
|------|------|
| `auto_launch_v2.sh` | v1 训练完成后自动启动 v2_ibl |
| `auto_launch_v2_beh.sh` | v2_ibl 完成后自动启动 v2_beh |
| `auto_launch_after_v1.sh` | v1 完成后的全套自动化启动流程 |
| `launch_v2.sh` | 手动启动 v2 训练的辅助脚本 |
| `training_queue.sh` | 顺序训练队列（v2_ibl → v2_beh → v2_mm → 消融实验） |

### 5.6 新增结果与日志文件

| 路径 | 内容 |
|------|------|
| `logs/neurohorizon/lightning_logs/version_5/` | NH v1 训练日志（hparams.yaml + metrics.csv） |
| `logs/neurohorizon_v2_ibl/lightning_logs/version_0/` | NH v2 IBL 训练日志 |
| `logs/poyo_baseline/lightning_logs/version_20/` | POYO baseline 训练日志 |
| `results/neurohorizon_v1_eval/metrics.json` | NH v1 评估指标 |
| `results/neurohorizon_v1_eval/summary.png` | NH v1 评估可视化 |
| `results/neurohorizon_v2_ibl_eval/metrics.json` | NH v2 评估指标 |
| `results/neurohorizon_v2_ibl_eval/summary.png` | NH v2 评估可视化 |
| `results/final_summary/all_results.json` | 所有模型结果汇总 |
| `results/final_summary/summary.md` | 最终结果汇总文档 |
| `results/comparison_summary.json` | 模型对比结果 |
| `figures/nh_training_curves.png` | NH 训练曲线图 |
| `figures/poyo_training_curves.png` | POYO 训练曲线图 |

### 5.7 新增 cc_todo 文档

| 文件 | 内容 |
|------|------|
| `cc_todo/2026-02-21-neurohorizon-工作日志.md` | 详细日志（v0.1-v1.8），记录每个 session 的操作、bug 修复、训练进度（持续更新） |
| `cc_todo/2026-02-21-neurohorizon-综合进展报告.md` | Phase 0-3 综合进展总结（2026-02-21 基准，v1.4） |
| `cc_todo/2026-02-21-neurohorizon-项目分析与执行计划.md` | 项目合理性评估 + 6 阶段执行计划 |
| `cc_todo/2026-02-21-poyo-代码分析.md` | POYO/POYO+ 代码架构分析（接口点识别） |

---

## 六、训练运行情况

### 6.1 POYO 基础验证训练（2026-02-19）

- 环境：`poyo` conda
- 数据集：MC Maze Small（pei_pandarinath_nlb_2021，141 samples）
- 配置：1.3M params，2 epoch 快速测试
- 结果：R²≈-0.03（正常，模型未收敛）
- checkpoint 路径：`autodl-tmp/torch_brain/examples/poyo/logs/lightning_logs/version_0/checkpoints/`

### 6.2 NeuroHorizon v1 训练（2026-02-21 至今）

- 配置：batch_size=16, 10 IBL sessions, 100 epochs, bf16-mixed, ~8.1M params
- 使用**未归一化**的参考特征
- 训练进度 checkpoint 目录：`logs/neurohorizon/lightning_logs/version_5/`
- PID: 34659，GPU 占用约 3.8 GiB

**验证结果历史（每 5 epoch）**：

| Epoch | val_loss | val_bits_per_spike |
|-------|----------|--------------------|
| 4 | 0.4670 | -1.0075 |
| 9 | 0.4214 | -0.7242 |
| 14 | 0.3982 | -0.5729 |
| 19 | 0.3895 | -0.5226 |
| 24 | 0.3841 | -0.4939 |
| 29 | — | — |
| 34 | 0.3809 | **-0.4621** |

- **趋势**：BPS 持续改善但速率放缓（-1.01 → -0.72 → -0.57 → -0.52 → -0.49 → -0.46）
- **预测**：最终（100 epoch）BPS 约 -0.42 ~ -0.40
- 无过拟合（val_loss ≈ train_loss）

**后训练评估结果（evaluate_neurohorizon.py，20 windows/session）**：

| Session | bits/spike | FR corr | R² |
|---------|-----------|---------|-----|
| 11163613 | -0.366 | 0.922 | 0.481 |
| 15b69921 | -0.645 | 0.837 | 0.215 |
| 5ae68c54 | -0.412 | 0.843 | 0.284 |
| 6899a67d | -0.569 | 0.738 | 0.103 |
| a7eba2cf | -0.365 | 0.866 | 0.513 |
| c46b8def | -0.403 | 0.869 | 0.481 |
| d85c454e | -0.256 | 0.963 | 0.315 |
| de905562 | -0.127 | 0.904 | 0.371 |
| e6594a5b | -0.787 | 0.753 | 0.152 |
| ebce500b | -0.817 | 0.603 | 0.066 |
| **平均** | **-0.475** | **0.830** | **0.298** |

### 6.3 POYO Baseline 训练（2026-02-21，已终止）

- 配置：POYO Small，200 epochs，batch_size=64，SparseLamb 优化器，IBL wheel velocity 解码
- checkpoint 目录：`logs/poyo_baseline/lightning_logs/version_20/`

**首次运行（version_0 ~ version_19，未成功）**：
- 训练在 epoch 106 后因所有验证 R² 均为负值（最佳 -0.050，最差 -0.520）被终止
- 根本原因：temporal split 导致 train/valid 行为分布严重不匹配 + POYO 的 per-unit learnable embedding 无法跨时间段泛化
- 释放 14.8 GB GPU 内存

**重修复后重启（version_20/21，2026-02-22）**：
- 修复了 3 个关键 bug（见下文 Bug 修复清单）
- GPU 训练已在 step 56+ 正常运行，loss 正常波动

### 6.4 NeuroHorizon v2 IBL 训练（2026-02-21，已完成）

- 配置：同 v1，但使用 **z-score 归一化**参考特征 + 更多验证指标（fr_corr、R²）
- checkpoint 目录：`logs/neurohorizon_v2_ibl/lightning_logs/version_0/`
- PID: 87666，GPU 占用约 3.8 GiB，**100 epoch 已完成**

**完整验证历史**：

| Epoch | val_loss | val_bps | val_fr_corr | val_r2 |
|-------|----------|---------|-------------|--------|
| 4 | 0.4138 | -0.679 | 0.733 | 0.320 |
| 9 | 0.3937 | -0.552 | 0.789 | 0.319 |
| 14 | 0.3811 | -0.467 | 0.808 | 0.392 |
| 19 | 0.3788 | -0.456 | 0.814 | 0.397 |
| 24 | 0.3765 | -0.446 | 0.819 | 0.396 |
| 29 | 0.3751 | -0.431 | 0.821 | 0.402 |
| 34 | 0.3752 | -0.426 | 0.828 | 0.401 |
| 39 | 0.3742 | -0.421 | 0.831 | 0.396 |
| 44 | 0.3740 | -0.427 | 0.831 | 0.398 |
| 49 | 0.3744 | -0.423 | 0.832 | 0.392 |
| 54 | 0.3718 | **-0.407** | 0.833 | **0.409** |
| 59 | 0.3714 | -0.409 | 0.832 | 0.408 |
| 64 | 0.3718 | -0.411 | **0.834** | 0.406 |
| 69 | 0.3699 | -0.404 | 0.835 | 0.408 |
| 74 | 0.3719 | -0.403 | 0.836 | 0.410 |
| 79 | 0.3716 | -0.405 | 0.834 | 0.408 |
| 84 | 0.3704 | -0.405 | 0.835 | 0.409 |
| 89 | 0.3708 | **-0.4019** | 0.836 | 0.410 |
| 94 | 0.3713 | -0.406 | 0.835 | 0.407 |
| 99 | 0.3715 | -0.402 | 0.836 | 0.409 |

- **最终最优指标**：BPS=-0.4019 (epoch 89)，fr_corr=0.836，R²=0.410
- **模型已收敛**：epoch 54 后 BPS 在 -0.402 ~ -0.411 范围振荡

**后训练评估结果**：

| Session | bits/spike | FR corr | R² |
|---------|-----------|---------|-----|
| 11163613 | -0.338 | 0.935 | 0.502 |
| 15b69921 | -0.538 | 0.875 | 0.234 |
| 5ae68c54 | -0.327 | 0.873 | 0.304 |
| 6899a67d | -0.461 | 0.790 | 0.122 |
| a7eba2cf | -0.287 | 0.900 | 0.545 |
| c46b8def | -0.358 | 0.886 | 0.503 |
| d85c454e | -0.238 | 0.965 | 0.317 |
| de905562 | **-0.119** | 0.913 | 0.369 |
| e6594a5b | -0.734 | 0.736 | 0.141 |
| ebce500b | -0.756 | 0.644 | 0.076 |
| **平均** | **-0.416** | **0.851** | **0.311** |

### 6.5 NeuroHorizon v2_beh / v2_mm 训练（失败，待重启）

- v2_beh 配置：IBL+Allen 15 sessions，归一化特征，behavior 条件，200 epochs
- v2_mm 配置：IBL+Allen 15 sessions，归一化特征，行为 + 图像（CLIP），200 epochs
- **失败原因**：GPU 显存不足（OOM）——v1 3.8G + POYO v21 14G = 18G，v2_beh 需要约 9G，剩余不足
- v2_beh 仅运行了 3 个 epoch，无有效 checkpoint
- 需等 v1 或 POYO v21 完成后重新启动

---

## 七、v1 vs v2 模型对比

| 指标 | v1（未归一化特征） | v2（z-score 归一化） | 改善 |
|------|-------------------|---------------------|------|
| Avg BPS（后训练评估） | -0.475 | -0.416 | **+12.4%** |
| Avg FR corr | 0.830 | 0.851 | **+2.5%** |
| Avg R² | 0.298 | 0.311 | **+4.4%** |
| 早期 BPS（epoch 4） | -1.008 | -0.679 | **+32.6%** |

**结论**：参考特征归一化在所有指标上均有改善，BPS 改善最为显著，且加速了收敛（相同性能下 v2 比 v1 少约 5 epoch）。

---

## 八、主要 Bug 修复记录

| Bug | 现象 | 修复方案 |
|-----|------|----------|
| allensdk numpy 版本冲突 | allensdk 要求 numpy==1.23.5 | 创建独立 allen conda 环境 |
| IBL Alyx REST 超时 | 复杂 django filter 查询超时 | 简化为 task_protocol + project |
| HDF5 缺少 temporaldata 元数据 | Dataset 加载失败 | 添加 object/timekeys/absolute_start 属性 |
| EagerDataset deepcopy 瓶颈 | 训练卡在 step 663 不动 | 覆写 `__getitem__` 避免 deepcopy，Data.slice() 已返回新对象 |
| POYO target 维度不匹配 | MSELoss 形状错误 | unsqueeze target when ndim==1 |
| Lightning setup() 覆盖 transform | collate 收到 temporaldata.Data 对象 | setup() 添加 `hasattr(self, 'train_dataset')` guard |
| Hydra `_target_` 被还原为 POYOPlus | 模型类型错误 | 绕过 hydra.utils.instantiate，显式使用 POYO() |
| 参考特征尺度极度不均匀 | IDEncoder 被 firing_rate 主导（max=224 vs ISI max~1） | z-score 归一化，备份原始到 `reference_features_raw` |
| multimodal collate 使用 intersection | 缺失模态的样本被丢弃 | 改用 union 语义 + `_collate_multimodal_keys` 零填充 |
| DINOv2 无法下载 | 网络访问受限 | 使用本机缓存 CLIP ViT-L/14（safetensors，HF_HUB_OFFLINE=1） |
| Allen 刺激数据格式不匹配 | start/end/frame 格式 vs 预期 timestamps | 展开 frame index → per-presentation embeddings |
| Padded8Object 属性错误（eval 脚本） | `hasattr(v, 'data')` 检查失败 | 改为 `hasattr(v, 'obj')` + 正确解包 `v.obj` |
| v1 评估使用错误特征 | HDF5 被归一化后 v1 评估 BPS=-9.17（灾难性） | 添加 `--use-raw-features` 参数使用 `reference_features_raw` |
| POYO task_emb 索引越界 | `Embedding(len(specs))` 大小为 1，但 modality ID=20 | 改为 `Embedding(max(spec.id)+1, dim)` |
| POYO loss=0.0 类型错误 | Lightning 拒绝 Python float | 改为 `torch.tensor(0.0, device=..., requires_grad=True)` |
| POYO `_target_` 指向 POYO 而非 POYOPlus | `readout_specs` 参数错误 | 修改 `poyo_small.yaml` 的 `_target_` 为 `torch_brain.models.POYOPlus` |

---

## 九、当前状态（截至 2026-02-22 最后一个 commit）

### 正在运行的训练
- **NH v1**：epoch 35/100（BPS=-0.462），预计最终 BPS ~-0.40
- **POYO baseline v21**：重修复后已重启，step 56+，loss 正常波动，200 epochs

### 等待 GPU 资源的训练
- **v2_beh**：待 v1 或 POYO 完成后重启（需约 9 GiB 显存）
- **v2_mm**：同上

### 未提交到 git 但存在的工作内容（untracked）
- `logs/neurohorizon/lightning_logs/version_0/` ~ `version_4/`（旧训练日志）
- `logs/neurohorizon_v2_beh/`（v2_beh 失败的 3 epoch 日志）
- `logs/neurohorizon_v2_mm/`（v2_mm 失败日志）
- `logs/poyo_baseline/lightning_logs/version_0/` ~ `version_19/`（历次 POYO 训练日志）
- `results/neurohorizon_v1_final_eval/`（v1 最终评估结果，含多个 pred_*.png）
- `results/neurohorizon_v2_ibl_eval/`（v2 评估结果，含多个 pred_*.png）
- `results/model_comparison.png`

---

## 十、待完成工作（后续计划）

### 短期
1. NH v1 100-epoch 训练完成后做最终评估（是否超过 null model）
2. POYO baseline v21 训练结果分析
3. GPU 释放后重启 v2_beh（IBL+Allen 15 sessions + behavior）
4. 再重启 v2_mm（全模态，image + behavior）

### 中期（Phase 4：实验）
5. 实验 1：跨 session 泛化（IDEncoder vs per-unit embedding vs random）
6. 实验 2：长时间预测跨度（100ms / 200ms / 500ms / 1s）
7. 实验 3：多模态消融（neural only → +behavior → +image → +both）
8. 实验 4：IDEncoder 消融（idencoder vs random vs mean）

### 长期（Phase 5：论文）
9. 结果收集与可视化（collect_results.py + plot_results.py）
10. 投稿目标：NeurIPS / ICLR / Nature Methods

---

## 十一、关键路径汇总

| 项目 | 路径 |
|------|------|
| 仓库根目录 | `autodl-tmp/NeuroHorizon/` |
| 核心模型代码 | `torch_brain/models/neurohorizon.py` |
| IDEncoder | `torch_brain/nn/id_encoder.py` |
| 多模态模块 | `torch_brain/nn/multimodal.py` |
| 训练脚本 | `examples/neurohorizon/train.py` |
| POYO baseline 脚本 | `examples/poyo_baseline/train.py` |
| IBL 数据集 | `autodl-tmp/datasets/ibl_processed/`（10个 HDF5） |
| Allen 数据集 | `autodl-tmp/datasets/allen_processed/`（5个 HDF5） |
| Allen 刺激帧 | `autodl-tmp/datasets/allen_stimuli/` |
| CLIP embedding | `autodl-tmp/datasets/allen_embeddings/` |
| NH v1 训练日志 | `logs/neurohorizon/lightning_logs/version_5/` |
| NH v2 IBL 训练日志 | `logs/neurohorizon_v2_ibl/lightning_logs/version_0/` |
| POYO baseline 日志 | `logs/poyo_baseline/lightning_logs/version_20/` |
| 评估结果 | `results/` |
| brainsets 配置 | `/root/.brainsets.yaml` |
| conda 环境（POYO） | `miniconda3/envs/poyo/` |
| conda 环境（Allen） | `miniconda3/envs/allen/` |
